<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gym Membership Management</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 10px;
            width: 600px;
            background-color: #f9f9f9;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
        .responseMessage {
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <h1>Gym Membership Management</h1>

    <h2>Create Membership</h2>
    <input type="text" id="firstName" placeholder="First Name" required>
    <input type="text" id="lastName" placeholder="Last Name" required>
    <input type="text" id="phoneNumber" placeholder="Phone Number" required>
    <input type="text" id="address" placeholder="Address" required>
    <input type="date" id="startDate" placeholder="Start Date" required>
    <select id="membershipType">
        <option value="" disabled selected>Select Membership Type</option>
        <option value="day">Day</option>
        <option value="weekly">Weekly</option>
        <option value="monthly">Monthly</option>
        <option value="quarterly">Quarterly</option>
        <option value="annually">Annually</option>
    </select>
    <select id="gymSelect">
        <option value="" disabled selected>Select Gym</option>
        <!-- Gym options will be populated here -->
    </select>
    <button id="createMembershipButton">Create Membership</button>
    <div id="responseMessage" class="responseMessage"></div>

    <h2>Existing Memberships</h2>
    <table id="membershipsTable">
        <thead>
            <tr>
                <th>ID</th>
                <th>First Name</th>
                <th>Last Name</th>
                <th>Phone Number</th>
                <th>Address</th>
                <th>Start Date</th>
                <th>Membership Type</th>
                <th>Days Until Expiration</th>
                <th>Membership Status</th>
                <th>Expiration Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            <!-- Memberships will be populated here -->
        </tbody>
    </table>

    <script type="text/javascript">
        $(document).ready(function() {
            // Get CSRF token from cookies
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        // Check if this cookie string begins with the name we want
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            const csrftoken = getCookie('csrftoken');

            // Function to load existing gyms
            function loadGyms() {
                $.ajax({
                    url: "/api/gyminfo/", // Replace with your endpoint for getting gyms
                    method: "GET",
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('access_token'),
                        'Content-Type': 'application/json'
                    },
                    success: function(gyms) {
                        const gymSelect = $('#gymSelect');
                        gyms.forEach(gym => {
                            gymSelect.append(`<option value="${gym.id}">${gym.gym_name}</option>`);
                        });
                    },
                    error: function(xhr) {
                        console.error("Error fetching gyms:", xhr.responseText);
                        $('#responseMessage').text('Failed to load gyms.').css('color', 'red');
                    }
                });
            }

            // Function to load existing memberships
            function loadMemberships() {
                $.ajax({
                    url: "/api/ownerCreatedmemberships/",
                    method: "GET",
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('access_token'),
                        'Content-Type': 'application/json'
                    },
                    success: function(memberships) {
                        const tbody = $('#membershipsTable tbody');
                        tbody.empty(); // Clear existing rows
                        memberships.forEach(membership => {
                            tbody.append(`
                                <tr>
                                    <td>${membership.id}</td>
                                    <td>${membership.first_name}</td>
                                    <td>${membership.last_name}</td>
                                    <td>${membership.phone_number}</td>
                                    <td>${membership.address}</td>
                                    <td>${membership.start_date}</td>
                                    <td>${membership.membership_type}</td>
                                    <td>${membership.days_until_expiration}</td>
                                    <td>${membership.membership_status}</td>
                                    <td>${membership.expiration_date}</td>
                                    <td>
                                        <button class="deleteMembershipButton" data-id="${membership.id}">Delete</button>
                                    </td>
                                </tr>
                            `);
                        });
                    },
                    error: function(xhr) {
                        console.error("Error fetching memberships:", xhr.responseText);
                        $('#responseMessage').text('Failed to load memberships.').css('color', 'red');
                    }
                });
            }

            // Load gyms and memberships on page load
            loadGyms();
            loadMemberships();

            // Create Membership Button Click Event
            $('#createMembershipButton').on('click', function() {
                let firstName = $('#firstName').val();
                let lastName = $('#lastName').val();
                let phoneNumber = $('#phoneNumber').val();
                let address = $('#address').val();
                let startDate = $('#startDate').val();
                let membershipType = $('#membershipType').val();
                let gymId = $('#gymSelect').val(); // Get the selected gym ID

                if (firstName && lastName && phoneNumber && address && startDate && membershipType && gymId) {
                    $.ajax({
                        url: "/api/ownerCreatedmemberships/",
                        method: "POST",
                        headers: {
                            'Authorization': 'Bearer ' + localStorage.getItem('access_token'),
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken // Include CSRF token
                        },
                        data: JSON.stringify({
                            "first_name": firstName,
                            "last_name": lastName,
                            "phone_number": phoneNumber,
                            "address": address,
                            "start_date": startDate,
                            "membership_type": membershipType,
                            "gym": gymId  // Include the gym ID
                        }),
                        success: function() {
                            $('#responseMessage').text('Membership created successfully!').css('color', 'green');
                            // Clear input fields
                            $('#firstName, #lastName, #phoneNumber, #address, #startDate').val('');
                            $('#membershipType').val(''); // Reset membership type
                            $('#gymSelect').val(''); // Reset gym selection
                            loadMemberships(); // Reload memberships
                        },
                        error: function(xhr) {
                            $('#responseMessage').text('Failed to create membership: ' + xhr.responseText).css('color', 'red');
                        }
                    });
                } else {
                    $('#responseMessage').text('Please fill in all fields.').css('color', 'red');
                }
            });

            // Delete Membership Button Click Event
            $(document).on('click', '.deleteMembershipButton', function() {
                const membershipId = $(this).data('id');
                $.ajax({
                    url: `/api/ownerCreatedmemberships/${membershipId}/`,
                    method: "DELETE",
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('access_token'),
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken // Include CSRF token
                    },
                    success: function() {
                        $('#responseMessage').text('Membership deleted successfully!').css('color', 'green');
                        loadMemberships(); // Reload memberships
                    },
                    error: function(xhr) {
                        $('#responseMessage').text('Failed to delete membership: ' + xhr.responseText).css('color', 'red');
                    }
                });
            });
        });
    </script>

</body>
</html>
